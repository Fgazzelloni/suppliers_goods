---
title: "Document"
description: "data driven insights on kombucha drinkers"
author: "Federica Gazzelloni"
date: "2024-03-12"
output: html_document
---

```{r setup, include=FALSE}
# Global R Chunk settings
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      eval = TRUE,
                      fig.align = "center") 
```


## Objectives

- group like-minded people together based on their mindsets and attitudes, not their demographic profile

- which type of customers are more or less likely to try `kombucha` and why


```{r}
library(tidyverse)
```

### Original data
```{r}
assignment_data <- readRDS('data/assignment_data.rds')
# assignment_data%>%View
assignment_data%>%names
```

```{r}
# labelled::var_label(assignment_data)
# names(assignment_data)
```


### Demo and Segment data
```{r}
demo <- assignment_data%>%
  select(starts_with("d_"))
# demo
```


```{r}
seg <- assignment_data %>%
  select(starts_with("seg_"))

seg1 <- seg%>%
  pivot_longer(cols = everything())%>%
  drop_na()
```

```{r}
seg1%>%summary()
```



```{r}
q_demo <- labelled::var_label(assignment_data)%>%
  as_data_frame()%>%
  select(starts_with("d_"))%>%
  pivot_longer(cols = everything())
```

```{r}
q_seg <- labelled::var_label(assignment_data)%>%
  as_data_frame()%>%
  select(-response_id)%>%
  pivot_longer(cols = everything())%>%
  filter(str_detect(name,"seg_"))%>%
  separate(value,into=c("a","question"),sep = "-")%>%
  select(-name,-a)%>%
  mutate(question=gsub("[/.]","",question),
         question=trimws(question))
q_seg
```

```{r}
q_sec_group <- labelled::var_label(assignment_data)%>%
  as_data_frame()%>%
  select(-response_id)%>%
  pivot_longer(cols = everything())%>%
  filter(str_detect(name,"seg_"))%>%
  select(-value)%>%
  mutate(name=gsub("seg_battery_","",name))%>%
  separate(name,into = c("Qgroup","Qnum"))

```


### Exploratory Data Analysis
```{r}
seg1%>%
  ggplot(aes(x = value, color = name)) + 
  geom_step(aes(y = ..y..), 
            stat = "ecdf",
            show.legend = F) +
  labs(y = "Cumulative Density") + 
  scale_x_discrete(limits = c("1","2","3","4"), 
                   breaks = c(1,2,3,4),
                   labels=c("strongly disagree", "disagree", 
                            "agree","strongly agree")) + 
  #scale_colour_manual(values = clrs3) + 
  theme_bw() 
```
#### Frequency Table
```{r}
bdat <- seg1 %>%
  dplyr::group_by(value) %>%
  dplyr::summarise(Frequency = n()) %>%
  dplyr::mutate(Percent = round(Frequency/sum(Frequency)*100, 1)) %>%
  # order the levels of Satisfaction manually so that the order is not alphabetical
  dplyr::mutate(Satisfaction = factor(value, 
                                      levels = 1:4,
                                      labels=c("strongly disagree", "disagree",
                                               "agree","strongly agree")))
bdat
```

### Pie Chart

```{r}
bdat %>%
  ggplot(aes("", Percent, fill = Satisfaction)) + 
  geom_bar(stat="identity", width=1, color = "white") +
  coord_polar("y", start=0) +
  #scale_fill_manual(values = clrs5) +
  theme_void()
```

```{r}
# create grouped pie data
gldat <- seg1 %>%
  dplyr::group_by(name, value) %>%
  dplyr::summarise(Frequency = n()) %>%
  dplyr::mutate(Percent = round(Frequency/sum(Frequency)*100, 1),
                Satisfaction = factor(value, 
                                      levels = 1:4,
                                      labels=c("strongly disagree", "disagree",
                                               "agree","strongly agree"))) %>%
  dplyr::arrange(desc(Satisfaction)) %>%
  dplyr::mutate(Position = cumsum(Percent)- 0.5*Percent)

gldat%>%arrange(desc(Percent))%>%head
```
```{r}
# gldat%>%count(name)
```

```{r}
# create pie chart
gldat %>%
  filter(name%in%c("seg_battery_a_1","seg_battery_a_2"))%>%
  ggplot(aes("", Percent, fill = Satisfaction)) + 
  facet_wrap(~name) +
  geom_bar(stat="identity", width=1, color = "white") +
  coord_polar("y", start=0) +
  #scale_fill_manual(values = clrs5) +
  theme_void() +
  geom_text(aes(y = Position, label = Percent), color = "white", size=4)
```


### Gender Grouping
```{r}
gender <- demo$d_gender
names(seg)<- paste("Q:",unlist(q_seg))

sdat <- cbind(id=as.integer(seq(1:1000)),gender,seg)
```



```{r}
survey <- sdat %>%
  dplyr::mutate_if(is.character, haven::as_factor) %>%
  dplyr::mutate_if(is.numeric, haven::as_factor) %>%
  drop_na() %>%
  as.data.frame()

# survey%>%head
```

```{r}
# install.packages("likert")
library(likert)
```


```{r}
plot(likert(survey[,3:53]), ordered = F, wrap= 60)
```
```{r}
ggsave("test.png",height = 12,width = 10)
```

```{r}
plot(likert(survey[,3:5], grouping = survey[,2]))
```

### How strongly correlated are the responses

### Metrics

- Cronbach’s $\alpha=\frac{N\bar{c}}{\bar{v}+(N-1)\bar{c}}$
- Guttman’s (G6) $\lambda$
- Omega $\omega$


```{r}
# install.packages("psych")
library(psych)
```

##### Survey data
```{r}
surveydata <- assignment_data%>%
  select(!starts_with("d_"))

surveydata%>%dim
```
#### Cronbach
```{r}
# calculate cronbach's alpha
Cronbach <- psych::alpha(surveydata[c("seg_battery_a_1",   
                   "seg_battery_a_2",  
                   "seg_battery_a_3")], check.keys=F)
# inspect results
Cronbach
```
#### Reliability

```{r}
# install.packages("ufs")
library(ufs)
```


```{r}
# extract reliability measures
reliability <- ufs::scaleStructure(surveydata[c("seg_battery_a_1",
                                                "seg_battery_a_2",
                                                "seg_battery_a_3")])
# inspect results
reliability
```


```{r}
q_seg
```


### Factor analysis

#### Demo
```{r}
# remove respondent
demo1 <- demo %>%
  select_if(is.numeric)%>%
  #drop_na() %>%
  as.data.frame() 

demo1[is.na(demo1)] <- 0
  

factoranalysis_d <- factanal(demo1,3)

# plot factor 1 by factor 2
load_d <- factoranalysis_d$loadings[,1:2]

load_d %>%
  as_data_frame()%>%
  cbind(q_demo=q_demo$name[-20]) %>%
  mutate(q_demo=gsub("d_","",q_demo))%>%
  ggplot(aes(x=Factor1,y=Factor2,label=q_demo,color=q_demo))+
  geom_text()+
  geom_abline()
```


#### Segment
```{r}
# remove respondent
seg1 <- seg%>%
  drop_na()

factoranalysis <- factanal(seg1, 3, rotation="varimax")

# print(factoranalysis, digits=2, cutoff=.2, sort=TRUE)
```



```{r}
# plot factor 1 by factor 2
load <- factoranalysis$loadings[,1:2]

load %>%
  as_data_frame()%>%
  cbind(q_group=q_sec_group$Qnum) %>%
  ggplot(aes(x=Factor1,y=Factor2,label=q_group,color=q_group))+
  geom_text()+
  geom_abline()
  
```


```{r}
load %>%
  as_data_frame()%>%
  cbind(q_group=q_seg$question) %>%
  ggplot(aes(x=Factor1,y=Factor2,label=q_group,color=q_group))+
  geom_text(show.legend = F,size=1)+
  geom_abline()
```





```{r}
# set up plot
plot(load, type="n", xlim = c(-1.5, 1.5)) 
# add variable names
text(load,
     # define labels
     labels=names(surveydata),
     # define font size 
     # (smaller than default = values smaller than 1)
     cex=.7)  
```
## Principle component analysis

```{r}
surveydata[is.na(surveydata)] <- 0

surveydata1 <- surveydata%>%
  select(-response_id)
```

```{r}
# entering raw data and extracting PCs  from the correlation matrix
PrincipalComponents <- princomp(surveydata1, cor=TRUE)
# summary(PrincipalComponents) # print variance accounted for
```


```{r}
# loadings(PrincipalComponents)
```

```{r}
plot(PrincipalComponents,type="lines") # scree plot
```
```{r}
groups <- demo%>%
  select(-20)%>%
  mutate_all(haven::as_factor)%>%
  pivot_longer(cols=everything())
```


```{r}
PrincipalComponents$scores %>%# the principal components
  as.data.frame()%>%
  select(1:2)%>%
  cbind(groups) %>%
  ggplot(aes(x=Comp.1,y=Comp.2,group=value))+
  geom_point(aes(color=value),
             size=0.5,
             alpha=0.5,
             show.legend = F)+
  facet_wrap(~name)
```
```{r}
PrincipalComponents$scores %>%# the principal components
  as.data.frame()%>%
  cbind(groups) %>%
  select(1,2,52,53) %>%
  mutate(value=haven::as_factor(value))%>%
  filter(name=="d_kom_drink")%>%
  drop_na()%>%
  ggplot(aes(x=Comp.1,y=Comp.2,group=value))+
  geom_point(aes(color=value),
             size=1,
             alpha=0.5,
             show.legend = F)
```

### TMWR

```{r}
library(tidymodels)
tidymodels_prefer()
# install.packages("bestNormalize")
library(bestNormalize)
```

```{r}
surveydata3 <- assignment_data%>%
  drop_na()%>%
  rename(gender=d_gender)%>%
  select(!contains("d_"),-response_id)

surveydata4 <- surveydata3%>%
  dplyr::mutate_if(is.character, haven::as_factor) %>%
  dplyr::mutate_if(is.numeric, haven::as_factor) %>%
  drop_na() %>%
  as.data.frame()
```


```{r}
set.seed(123)
split <- initial_split(surveydata4,prop = 0.7,strata = gender)
training<- training(split)
testing <- testing(split)
```


```{r}
survey_rec <- 
  # Use the training data from the bean_val split object
  recipe(gender ~ ., data = training) %>%
  step_zv(all_numeric_predictors()) %>%
  step_dummy(all_factor_predictors())%>%
  step_orderNorm(all_numeric_predictors()) %>% 
  step_normalize(all_numeric_predictors())
```

```{r}
survey_rec_trained <- survey_rec%>%prep()
```

```{r}
library(ggforce)
plot_validation_results <- function(recipe, dat = training) {
  recipe %>%
    # Estimate any additional steps
    prep() %>%
    # Process the data (the validation set by default)
    bake(new_data = dat) %>%
    # Create the scatterplot matrix
    ggplot(aes(x = .panel_x, y = .panel_y, color = gender, fill = gender)) +
    geom_point(alpha = 0.4, size = 0.5) +
    geom_autodensity(alpha = .3) +
    facet_matrix(vars(-gender), layer.diag = 2) 
    #scale_color_brewer(palette = "Dark2") + 
    #scale_fill_brewer(palette = "Dark2")
}
```

```{r}
survey_rec_trained %>%
  step_pca(all_numeric_predictors(), num_comp = 4) %>%
  plot_validation_results() + 
  ggtitle("Principal Component Analysis")
```






## Ordinal Regression
```{r}
names(seg)<- paste("Q:",unlist(q_seg))
sdat <- cbind(id=as.integer(seq(1:1000)),demo,seg)

survey <- sdat %>%
  dplyr::mutate_if(is.character, haven::as_factor) %>%
  dplyr::mutate_if(is.numeric, haven::as_factor) %>%
  drop_na() %>%
  as.data.frame()
```

```{r}
## fit ordered logit model and store results 'm'
m <- MASS::polr(d_interested ~ d_gender+d_hhincome, data = survey)
## view a summary of the model
summary(m)
```



## Resouces

- <https://ladal.edu.au/surveys.html>
- <https://rpubs.com/Michiel_Vermeulen/1166392>











